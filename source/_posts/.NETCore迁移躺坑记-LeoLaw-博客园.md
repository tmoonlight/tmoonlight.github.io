---
title: .NETCore迁移躺坑记-LeoLaw-博客园
date: 2013/11/14 22:29:15
tags:
---


[](https://www.cnblogs.com/leolaw/p/10740678.html)

[](https://www.cnblogs.com/leolaw/)

# [LeoLaw](https://www.cnblogs.com/leolaw/)

## 

  * [博客园](https://www.cnblogs.com/)
  * [首页](https://www.cnblogs.com/leolaw/)
  * [新随笔](https://i.cnblogs.com/EditPosts.aspx?opt=1)
  * [联系](https://msg.cnblogs.com/send/LeoLaw)
  * [订阅](https://www.cnblogs.com/leolaw/rss)
  * [管理](https://i.cnblogs.com/)



随笔 - 11   文章 - 1   评论 - 65

#  [.NET Core 迁移躺坑记](https://www.cnblogs.com/leolaw/p/10740678.html)

最近将自己负责的一个核心接口系统从.Net Framework迁移到了.Net Core。

整体过程，从业务层面说一般般吧(整体还好但还是搞的业务有感，没出严重故障）但是技术层面上感觉其实并没有达到要求，不过预期也是应该不会那么顺利，接下来可能还需要几个小Fix来处理各种奇奇怪怪的问题。

回顾下迁移时候遇到的若干个坑，希望对后续有此类操作的人所有帮助。

 

## 1.NetCore下的路由行为和Web Api的不一致

我们回顾下在Web Api里时候的一个路由定义

[](https://img2018.cnblogs.com/blog/658343/201904/658343-20190420132240142-2088271074.png)

这个配置下可以让

**Get RootUrl/123** 和 **Get RootUrl?id=123** 同时映射到 GetThirdPartyChannel方法里。

但是，假如在不做改动前提下直接将这个Controller定义变为Core的话， **Get RootUrl?id=123** 这个路由将无法正常运作 (而 **Get RootUrl/123** 则依然可以正常运行 **）。**

原因是在AspNetCore下他发现了[Route(“{Id}”)]就会认为Id是Path的一部分，然后相当于隐式给id这个参数默认了[FromPath],但是[Route(“”)]这里并没有定义id作为Path。

会导致一旦调用 **Get RootUrl?id=123** 的时候，首先路由是能匹配上 [Route(“”)]的，但是参数里的id恒定是空(即代码里获取到的id字段永远是null)。

 

### 解决方案有2种

①强制在方法参数的id里加上[FromQuery],但是这个会有个咖喱是Swagger生成的文档里会有2个Id字段（Path里有一个，你强制了Query里有一个）但是接口能正常工作；

②将2个路由拆开来分别对应2个方法。

 

**总结：**

按照我们组内规范，定义Url是不能放Path的，这些都是一些早期设计的，没有遵照规范将其替换完一直遗留着， **规范不严格，代码两行泪。**

****

## 2.NetCore下加载程序集的时候会识别版本号

我们有使用到部分的类库会依赖动态程序集加载，目前有：

**Hangfire** 用于实现Fire-and-Forgot模式异步执行以及延迟任务；

**Protobuf-net** 用于存储到Redis的时候转Protobuf更快更小。

 

这类程序集有个特点是他要将你要执行的东西序列化为某种类型（我不管json还是二进制的信息），然后需要时候在加载程序集。

而他们序列化的时候对程序集的处理统统都是用了Type.AssemblyQualifiedName方法，改方法可能会产生类似“ClassLibrary1.Class1, ClassLibrary1, Version=1.2.0.0, Culture=neutral, PublicKeyToken=null”的字符串。

而我们自己在CI的时候有一个机制是，每次TFS编译的时候会自动修改dll的版本号，具体可以参考以前写的文章 [Azure Devops/Tfs 编译的时候自动修改版本号](https://www.cnblogs.com/leolaw/p/10468393.html)

以前.Net Framework加载一个程序集的时候，比如程序集的信息是 “ClassLibrary1.Class1, ClassLibrary1, Version=1.2.0.0, Culture=neutral, PublicKeyToken=null”   其中的Version的值他是不认的，随便Version是什么他都能加载（咱不讨论StrongName模式）

而到Core之后如果Version不匹配，则会报错（他会认可Version的值了）

 

#### 解决方案：

暂时去掉了自动修改版本号机制，固定版本号到某个值。

 

## 3.NetCore下的Redis有点诡异（不稳定）

具体体现在好像迁移到Core之后连接Redis的链接更不稳定了，无论是链接超时还是首次建立链接的成功率都显著下降。

也是因为这个问题导致这次发布闹出了不该有的动静。

### 发布那会的临时解决方案：

Redis的链接字符串加了,abortConnect=false让连接不上的时候也继续跑着先吧

### 进行中的解决方案

根据<https://stackoverflow.com/questions/42956377/stackexchange-redis-timeout-exception-in-net-core>

试着将代码内频繁查询的Redis读取转Async试试。

 

## 4.NetCore下的Http请求不稳定（时而报SocketException)

到Core之后我们的未知知识库里又新增了一个全新异常模式

[](https://img2018.cnblogs.com/blog/658343/201904/658343-20190420132240595-363313660.png)

这个异常看起来像如下几个地址里提到的情况

<https://github.com/dotnet/corefx/issues/30691> 

<https://github.com/dotnet/corefx/pull/32903> 

<https://github.com/dotnet/corefx/issues/32902>

但是要说3.0才fix，等不了那么久……

 

另外已知在小访问量下好像不容易出现这个（我们之前已经有几个小站点已经是core里但是都没发生这个问题），有概率跟请求压力有关系。

 

### 目前的临时解决方案

参考官方文档 <https://docs.microsoft.com/en-us/dotnet/api/system.net.http.socketshttphandler?view=netcore-2.2> 先将core2.1引入的SocketHttpHandler禁用了

可以直接Powershell执行
    
    
    [environment]::SetEnvironmentvariable("DOTNET_SYSTEM_NET_HTTP_USESOCKETSHTTPHANDLER", "false", "Machine")  
    
    

但是现在也是零星会偶尔冒一下出来（感觉并没有什么卵用）

### 进行中的解决方案

基于HttpClientFactory构造HttpClient外加Polly如果失败就再来一次的模式。

 

## 5.迷之超时

现在发觉有一部分机器会有超时的现象，而这个现象比较诡异在于IIS日志里是有记录到这次请求的（超时的请求），而作为我们站点监控的Application Insights是没收到这个请求的

暂时想法是不是因为现在IIS只是一个Reverse Proxy的角色，而IIS到达真正承载站点的kestrel的时候这个过程有问题

[](https://img2018.cnblogs.com/blog/658343/201904/658343-20190420132240984-1949676203.png)

 

因为我们当前是基于Net Core 2.1(因为是LTS），并没有2.2所引入的进程内托管这种模式，这个问题目前还在定位中

 

另外有人建议（包括网上寻找资料得到的信息）是IIS里调整下

Start Mode 改为Always Runing

Idel Time-out Action改为Suspend

但是这都是Win 2012才引入的功能，而我们家是08R2，两行泪的羡慕隔壁好多家都是2016的！

 

### 临时解决方案：

看到超时的机器就下掉

而且发现这个超时现象主要集中在某几个服务器上

### 之后在看看系列的解决方案

后面转Linux后的话直接kestrel硬扛，IIS一边去

 

## 最后

好像在.Net Framework里经常推崇的在异步方法里加 **ConfigureAwaiter(false)** 在.Net Core下是没什么卵用的，参考

<http://blog.stephencleary.com/2017/03/aspnetcore-synchronization-context.html>

标签: [net](https://www.cnblogs.com/leolaw/tag/net/), [netcore](https://www.cnblogs.com/leolaw/tag/netcore/)

好文要顶 关注我 收藏该文

[](http://home.cnblogs.com/u/leolaw/)

[LeoLaw](http://home.cnblogs.com/u/leolaw/)  
[关注 - 4](http://home.cnblogs.com/u/leolaw/followees)  
[粉丝 - 20](http://home.cnblogs.com/u/leolaw/followers)

+加关注

24

0

[« ](https://www.cnblogs.com/leolaw/p/10546239.html) 上一篇：[初探奥尔良(Orleans)](https://www.cnblogs.com/leolaw/p/10546239.html "发布于2019-03-17 12:26")  


posted @ 2019-04-20 13:23 [LeoLaw](https://www.cnblogs.com/leolaw/) 阅读(3396) 评论(39) [编辑](https://i.cnblogs.com/EditPosts.aspx?postid=10740678) [收藏](https://www.cnblogs.com/leolaw/p/10740678.html#)

[](https://www.cnblogs.com/leolaw/p/10740678.html)

  


评论列表

  

[#1楼](https://www.cnblogs.com/leolaw/p/10740678.html#4236081)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-20 20:41 [WeihanLi](https://www.cnblogs.com/weihanli/) [ ](http://msg.cnblogs.com/send/WeihanLi "发送站内短消息")

ConfigureAwaiter(false) 不是没什么卵用了，是不需要了

支持(0)反对(0)

  

[#2楼](https://www.cnblogs.com/leolaw/p/10740678.html#4236089)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-20 20:51 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4236081 "查看所回复的评论") WeihanLi  


[引用](https://www.cnblogs.com/leolaw/p/10740678.html#4236081 "查看引用原文")

  
ConfigureAwaiter(false) 不是没什么卵用了，是不需要了  


  
加了和没加一样不就是没卵用了吗 😂 （加不加都由于没了syncContext所以没啥意义了）

支持(0)反对(0)

  

[#3楼](https://www.cnblogs.com/leolaw/p/10740678.html#4236092)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-20 20:55 [WeihanLi](https://www.cnblogs.com/weihanli/) [ ](http://msg.cnblogs.com/send/WeihanLi "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4236089 "查看所回复的评论") LeoLaw  
对，只是想突出 .NET Core 更好了，不需要再加 ConfigureAwaiter(false) 了，哈哈哈

支持(0)反对(0)

  

[#4楼](https://www.cnblogs.com/leolaw/p/10740678.html#4236250)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-21 09:33 [c99](https://www.cnblogs.com/aliasmic/) [ ](http://msg.cnblogs.com/send/c99 "发送站内短消息")

“kestrel硬扛”  
  
这怕不行...

支持(0)反对(0)

  

[#5楼](https://www.cnblogs.com/leolaw/p/10740678.html#4236252)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-21 09:36 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4236250 "查看所回复的评论") c99  
我的意思是本机服务器里直接kestrel暴露端口给外部访问  
宏观的外部系统架构上是有nginx做软负载转发到kestrel  
  
因为本机上加装个反向代理我认为是没啥意义的  
反向代理就交给专业的外部反向代理处理

支持(0)反对(0)

  

[#6楼](https://www.cnblogs.com/leolaw/p/10740678.html#4236343)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-21 12:35 [maochiyu](http://home.cnblogs.com/u/153897/) [ ](http://msg.cnblogs.com/send/maochiyu "发送站内短消息")

升级到2.2 使用iis inprocess 托管 超时 内存消耗要好很多，之前高并发经常报错

支持(0)反对(0)

  

[#7楼](https://www.cnblogs.com/leolaw/p/10740678.html#4236384)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-21 13:57 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4236343 "查看所回复的评论") maochiyu  
会么，产品说明书上不是说这个是更快的么  
有提相关issus或者有相关的说明么  
（怕怕的，感觉坑不少啊）

支持(0)反对(0)

  

[#8楼](https://www.cnblogs.com/leolaw/p/10740678.html#4236387)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-21 14:05 [maochiyu](http://home.cnblogs.com/u/153897/) [ ](http://msg.cnblogs.com/send/maochiyu "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4236384 "查看所回复的评论") LeoLaw  
升级到2.2很简单的，有官网升级说明，iis进程内托管性能要好很多

支持(0)反对(0)

  

[#9楼](https://www.cnblogs.com/leolaw/p/10740678.html#4236389)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-21 14:07 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4236387 "查看所回复的评论") maochiyu  
😂  
原来是我之前看错 我以为是升级2.2后超时/报错多   
刚看下原来是“好很多”  
  
也就是你们是在in process下自然而然解决了超时/报错的问题吗

支持(0)反对(0)

  

[#10楼](https://www.cnblogs.com/leolaw/p/10740678.html#4236945)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 02:17 [vbfool](https://www.cnblogs.com/vbfool/) [ ](http://msg.cnblogs.com/send/vbfool "发送站内短消息")

第一个Path里带参数一般是为了更restful，其实很多时候没啥卵用。  
稳定的使用一个路由模式就好了，玩多了就容易玩脱。

支持(0)反对(0)

  

[#11楼](https://www.cnblogs.com/leolaw/p/10740678.html#4236953)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 08:03 [TakeTry](https://www.cnblogs.com/lztkdr/) [ ](http://msg.cnblogs.com/send/TakeTry "发送站内短消息")

前辈踩坑，填坑，后人无坑。  
作为围观者，感觉还是等到3.0，再大规模使用.core 3.0做新业务。

支持(0)反对(0)

  

[#12楼](https://www.cnblogs.com/leolaw/p/10740678.html#4236978)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-22 09:07 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4236945 "查看所回复的评论") vbfool  
一开始我们也是遵照restful的规范在path里定义参数  
但是后面发觉最起码会有一个问题，就是监控的时候这个路由会被当成多个  
比如 get rootUrl/123 和 get rootUrl/321 按道理他都是 get rootUrl/{id}但是会被我们用的监控（application insights)认为是2个 而且不好group by  
  
所以后面规范里都要求不允许将参数作为path  
  
补充 core里的insights是没有这个问题，他是用方法名来作为OperationName，仅framework有这个问题

支持(0)反对(0)

  

[#13楼](https://www.cnblogs.com/leolaw/p/10740678.html#4236979)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-22 09:09 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4236953 "查看所回复的评论") TakeTry  
Core3预计5月发，然后按照我们计划一个新版本要一个季度后才能投入生产，然后此时3.1 preview预计也出来了，然后又想等。。这样无穷无尽等下去不是个事  
  
所以看准差不多就上吧  
坑是肯定有的，主要是这个坑是不是核心坑，遇上一些奇奇怪怪边缘性质的就算了，当攒经验吧

支持(2)反对(0)

  

[#14楼](https://www.cnblogs.com/leolaw/p/10740678.html#4236993)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 09:18 [TakeTry](https://www.cnblogs.com/lztkdr/) [ ](http://msg.cnblogs.com/send/TakeTry "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4236979 "查看所回复的评论") LeoLaw  
  
"因为我们当前是基于Net Core 2.1(因为是LTS），并没有2.2所引入的进程内托管这种模式，这个问题目前还在定位中 "  
  
  
  
看楼主，用的是 .net core 2.1 ，是吗？文中你说的 Net Core 2.1 LTS 和 截图中的 .Net Core 2.1 有什么区别吗？还有些疑惑 为什么不用 2.2 呢？

支持(0)反对(0)

  

[#15楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237007)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-22 09:29 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4236993 "查看所回复的评论") TakeTry  
.net core 2.1是属于LTS版  
  
LTS是长期支持版，会提供长达3年的支持  
而2.2属于Current版，Current会在下一个Current版发布之后3个月后就终止支持  
  
这个就涉及到和运维那边的关系  
运维是不希望经常折腾  
  
我们协商是只用lts版，另外在下一个lts版发布一个季度后，我们就升级到下一个lts

支持(2)反对(0)

  

[#16楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237008)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-22 09:30 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4236993 "查看所回复的评论") TakeTry  
LTS和Current的区别可以参考下官方的说明  
<https://dotnet.microsoft.com/platform/support/policy/dotnet-core>

支持(2)反对(0)

  

[#17楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237021)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 09:36 [TakeTry](https://www.cnblogs.com/lztkdr/) [ ](http://msg.cnblogs.com/send/TakeTry "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4237008 "查看所回复的评论") LeoLaw  
开发中，没有注意到 这些细节，学些了，谢谢楼主！

支持(0)反对(0)

  

[#18楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237034)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 09:44 [提伯斯](https://www.cnblogs.com/tibos/) [ ](http://msg.cnblogs.com/send/%E6%8F%90%E4%BC%AF%E6%96%AF "发送站内短消息")

关于楼主提到的问题  
问题2, 建议使用git托管代码,爽的一笔  
问题3.Stackexchange.Redis 不稳定连接超时(超过20个并发就出问题了,可以用测试工具测试一下),建议设置一下线程数  
ThreadPool.SetMinThreads(200, 200);  
问题4.没有遇到过,哈哈  
问题5.core默认都是使用的kestrel做应用程序服务器,iis,nginx,只做转发,因为我这边都是部署在linux,所以没有遇到这种情况

支持(0)反对(0)

  

[#19楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237036)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 09:47 [b4b4](https://www.cnblogs.com/cedd/) [ ](http://msg.cnblogs.com/send/b4b4 "发送站内短消息")

get 到版本区别知识了。  
  
再问一个：  
如何才能使用Application Insights？  
需要付费么？

支持(0)反对(0)

  

[#20楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237038)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-22 09:48 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4237034 "查看所回复的评论") 提伯斯  
问题2 我们是用git托管代码的（Tfs在2015后是支持tfvc和git两种模式，我们都是用git模式，跟正统git是一摸一样的），我这里说的是代码写好后自动发布的流程里，我们会自动修改版本号（由TFS的CI管道控制的）  
  
问题3 我们先试着将缓存读取都转Async模式先，因为是从framework的代码迁移过去，以前里面都以同步读缓存的模式居多  
  
问题5 我是觉得iis多余，因为上层已经有nginx，而且我觉得可能跟过老的08R2也有点关系，不过后续我们也是准备迁移linux

支持(0)反对(0)

  

[#21楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237042)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-22 09:50 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4237036 "查看所回复的评论") b4b4  
Application insights是Azure上的一个服务，需要付费的，按照监控数据大小收取  
如果你有测试版的azure订阅的话，每个月1GB以内的数据是免费的  
另外insights只有国际版有，世纪互联的那个azure是没有的

支持(0)反对(0)

  

[#22楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237045)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 09:52 [为乐而来](https://www.cnblogs.com/q149072205/) [ ](http://msg.cnblogs.com/send/%E4%B8%BA%E4%B9%90%E8%80%8C%E6%9D%A5 "发送站内短消息")

.net Core还是发布在IIS上？  
估计发到Liunx上坑更多。

支持(0)反对(0)

  

[#23楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237048)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-22 09:55 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4237045 "查看所回复的评论") 为乐而来  
目前我们是到iis上，因为是传统的framework转过来的，先放win上跑段时间，后续稳定后在转linux  
  
感觉linux上坑好像少一些，我们有一部分项目上了linux反而风平浪静  
  
当然有可能是因为我们linux用的相对新一些（centos 7.2)  
而win是08r2  
  
CentOs7.2起码也相当于win2012R2级别或者更新的2016了

支持(0)反对(0)

  

[#24楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237067)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 10:10 [张飞洪](https://www.cnblogs.com/jackyfei/) [ ](http://msg.cnblogs.com/send/%E5%BC%A0%E9%A3%9E%E6%B4%AA "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4236979 "查看所回复的评论") LeoLaw  
周边的生态和类库升级我估计最少也得要一两年。

支持(0)反对(0)

  

[#25楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237083)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 10:26 [LiyanTan](http://home.cnblogs.com/u/858742/) [ ](http://msg.cnblogs.com/send/LiyanTan "发送站内短消息")

顶

支持(0)反对(0)

  

[#26楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237086)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 10:33 ['今晚打老虎'](https://www.cnblogs.com/TigerKwan/)  

Redis超时问题可参考以下说明：  
<https://github.com/StackExchange/StackExchange.Redis/blob/master/docs/Timeouts.md>  
重点考察线程创建速度，跟请求速度是否匹配得上  
ThreadPool.SetMinThreads(…)   
  
  
同时也建议升级到2.x版本  
2.0 is a large - and breaking - change  
<https://github.com/StackExchange/StackExchange.Redis/blob/master/docs/ReleaseNotes.md>

支持(0)反对(0)

  

[#27楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237123)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 10:56 [delowly](https://www.cnblogs.com/delowly/) [ ](http://msg.cnblogs.com/send/delowly "发送站内短消息")

安利一下，用Java吧，java不会有这些问题

支持(1)反对(0)

  

[#28楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237136)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-22 11:07 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4237067 "查看所回复的评论") 张飞洪  
目前core自身生态是没问题了的，2.x之后各种东西都挺完善了  
现在的类库，只要是还有在维护的，基本都是有支持standard2.0的（同时兼容net framework 4.6.1和netcore2以上）  
  
netcore是2015年时候出来，现在都2019年了，如果出来的时候说“过几年就完善了”那现在已经是属于过了几年的那个阶段了

支持(0)反对(0)

  

[#29楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237141)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-22 11:09 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4237086 "查看所回复的评论") '今晚打老虎'  
我们用的就是2.x的版本StackExchange.Redis  
  
ThreadPool.SetMinThreads因为这个现在觉得不好订到底多少是合适，在Async改造后如果还有问题的话后续在跟进这个处理方案，个人观念是尽量少动系统配置，而尽可能从代码层面去处理。 当然代码没法处理了的话，该动配置还是要动的

支持(0)反对(0)

  

[#30楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237143)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 11:09 [Adming](https://www.cnblogs.com/weapon/) [ ](http://msg.cnblogs.com/send/Adming "发送站内短消息")

我们也是，现在卡在第一个路由不匹配的问题上，导致我们WebApi只能以兼容模式运行（安装Microsoft.AspNetCore.Mvc.WebApiCompatShim包，目标框架还是用.NET Framework4.6.2或4.7.2）,这样可以保持ASP.NET 4.x Web API 项目迁移到 ASP.NET Core Web API时路由约定不变。  
不过.NET Framework和.NET Core混用也有很多兼容性问题，经常遇到本地可以运行，发布到正式服务器后提示某个引用的程序集找不到，这通常是类库之间引用的版本不一致造成的，虽然可以通过配置 .config 文件assemblyBinding 可以解决部分问题，但这个配置无论是自动更新还是手动配置都不能完全解决，特别是有多个入口项目时。  
但是，由于历史原因，我们又不得不用这种方案，我们所在的行业属于那种7×24小时不间断运行的，一但出现故障客户就开始闹的那种，而且目前的WebApi接口有近千个，又同时有B/S、C/S相种客户端，这种情况下如果接口路由约定变了，工作量就大了，客户端开发人员很不会配合，而且风险太大，所有我们现在就一直卡在兼容模式上了。

支持(0)反对(0)

  

[#31楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237162)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-22 11:23 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4237123 "查看所回复的评论") delowly  
其实我们这新组建的java团队遇到的问题比.net更多  
我们公司本身是.net为主，现在领导也觉得可能行业java多也组建java  
但是java团队更多是拉个外面第三方框架就拿来用（当然 多数是什么阿里的 腾讯的之类的）  
  
而我们.net团队起码比如转core的过程中，很多事情我们都是研究的比较透彻。  
而作为.net开发人员我觉得我也有义务保持.net的主导，同时也要满足上头的一些需求（比如迁linux节省成本）  
  
觉得一个人对语言首先是不能有偏见的，但是是要有偏好的，而我个人就是偏好.net

支持(1)反对(0)

  

[#32楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237170)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-22 11:27 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4237143 "查看所回复的评论") Adming  
看上去你们情况还是历史包袱重  
  
我说说我这边情况，我这也跟你们差不多很多历史包袱,但是首先上头也明确了这个事情是要做的  
我想法是先上几个小当量的新项目到core，后续在上一个核心系统，在对一些奇奇怪怪的问题做好应对处理方案后就全方位铺开  
而这次我这上线的就是属于核心系统的重要一环(订单系统，也是访问量最高的）  
  
经过这个核心系统的洗礼后，首先要证明：core是可以的 并且也要总结出各种可能遇到的情况（因为这个项目基本代表最复杂的应用场景了）  
  
后续在培训下大家，首先以后的东西的规范是应该怎样，不应该怎样（比如url规范就可以定下来了） 之后在慢慢过渡迁移（没错，我们计划表都做到2020甚至还有2021的）

支持(0)反对(0)

  

[#33楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237176)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 11:31 [Adming](https://www.cnblogs.com/weapon/) [ ](http://msg.cnblogs.com/send/Adming "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4237170 "查看所回复的评论") LeoLaw  
看来你们公司还不错，还有计划，我们公司这些完全没有计划。

支持(0)反对(0)

  

[#34楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237248)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-22 13:10 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4237176 "查看所回复的评论") Adming  
一方面是自己尽量多安利领导，技术方面不说多先进但起码不能落后太多个档次，就framework现在这样子可以预见未来只有维护性质了的，不在能支持到“面向未来”的层次需求  
  
然后就是列计划，第一步怎么做，然后发生的问题怎么处理，如何确保以后是没这个问题，当前期预案都ok后在抽出几个代表性质的个别项目（最好负责人技术能力比较强的）来进行试点，试点后就定规范，后续其他项目全部按照此规范走，之后在情况允许之后在批量迁（个人设想的打算）

支持(0)反对(0)

  

[#35楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237444)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 16:54 [麦兜很乖](https://www.cnblogs.com/wangjun8868/) [ ](http://msg.cnblogs.com/send/%E9%BA%A6%E5%85%9C%E5%BE%88%E4%B9%96 "发送站内短消息")

Redis 超时可以用CSRedis 组件解决

支持(0)反对(0)

  

[#36楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237456)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-22 17:06 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4237444 "查看所回复的评论") 麦兜很乖  
换类库有点儿。。工程量大  
先看下如果换异步方法依然有问题可能会考虑更换

支持(0)反对(0)

  

[#37楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237458)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 17:07 [麦兜很乖](https://www.cnblogs.com/wangjun8868/) [ ](http://msg.cnblogs.com/send/%E9%BA%A6%E5%85%9C%E5%BE%88%E4%B9%96 "发送站内短消息")

HttpClient的问题可以这么解决。  
注入  
services.AddHttpClient("myhttp");  
调用  
HttpClient client = _httpClientFactory.CreateClient("myhttp");

支持(0)反对(0)

  

[#38楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237483)[](https://www.cnblogs.com/leolaw/p/10740678.html) 2019-04-22 17:29 [程小王](https://www.cnblogs.com/smlheart/) [ ](http://msg.cnblogs.com/send/%E7%A8%8B%E5%B0%8F%E7%8E%8B "发送站内短消息")

你要是把core再布置到k8s就会遇到更多坑  
你要是把core再布置到谷歌和亚马逊的k8s就会遇到更多更多坑  
\----  
不说了

支持(0)反对(0)

  

[#39楼](https://www.cnblogs.com/leolaw/p/10740678.html#4237485)[](https://www.cnblogs.com/leolaw/p/10740678.html)[楼主] 2019-04-22 17:30 [LeoLaw](https://www.cnblogs.com/leolaw/) [ ](http://msg.cnblogs.com/send/LeoLaw "发送站内短消息")

[@](https://www.cnblogs.com/leolaw/p/10740678.html#4237458 "查看所回复的评论") 麦兜很乖  
嗯 这个是HttpClientFactory的套路  
我们正在进行中的就是这个，等周三发布上去在看效果  
目前我自己在测试环境下压测看起来效果良好

支持(0)反对(0)

[](https://www.cnblogs.com/leolaw/p/10740678.html)

刷新评论[刷新页面](https://www.cnblogs.com/leolaw/p/10740678.html#)[返回顶部](https://www.cnblogs.com/leolaw/p/10740678.html#top)

注册用户登录后才能发表评论，请 登录 或 注册，[访问](http://www.cnblogs.com/)网站首页。

[【推荐】超50万C++/C#源码: 大型实时仿真组态图形源码](http://www.ucancode.com/index.htm)  
[【培训】IT职业生涯指南，Java程序员薪资翻3倍的秘密](https://ke.qq.com/adActivity.html?name=xiangxueketang2)  
[【推荐】工作996，生病ICU，程序员不加班就没前途吗？](https://group.cnblogs.com/topic/81213.html)  
[【推荐】专业便捷的企业级代码托管服务 - Gitee 码云](https://gitee.com/enterprises?from=bky-2)  


**相关博文：**  
· [ASP.NETCORE系列【六】EntityFrameworkCore之数据迁移](https://www.cnblogs.com/lonelyxmas/p/9197277.html)  
· [EF Core codefirst数据迁移](https://www.cnblogs.com/paulin/p/8681249.html)  
· [.NET 4.5+项目迁移.NET Core的问题记录](https://www.cnblogs.com/ronli/p/5900001.html)  
· [.net core 2.0学习笔记（四）：迁移.net framework 工程到.net core](https://www.cnblogs.com/vveiliang/p/7409825.html)  
· [从博客园博问站点迁移ASP.NET Core展望.NET Core](https://www.cnblogs.com/CoderAyu/p/8490142.html)  


**最新新闻** ：  
· [社交悬崖上的京东](https://news.cnblogs.com/n/624194/)  
· [4K电视渗透率近七成 超高清视频产业迎来战略机遇期](https://news.cnblogs.com/n/624192/)  
· [一季度或落后华为三分之一，苹果手机销量继续下滑](https://news.cnblogs.com/n/624191/)  
· [传统景区纷纷开启“刷脸游”](https://news.cnblogs.com/n/624190/)  
· [一加7/7Pro配置曝光 首发UFS3.0闪存/2K屏/更有5G版](https://news.cnblogs.com/n/624189/)  
» [更多新闻...](http://news.cnblogs.com/ "IT新闻")

### 公告

昵称：[LeoLaw](https://home.cnblogs.com/u/leolaw/)  
园龄：[4年8个月](https://home.cnblogs.com/u/leolaw/ "入园时间：2014-08-01")  
粉丝：[20](https://home.cnblogs.com/u/leolaw/followers/)  
关注：[4](https://home.cnblogs.com/u/leolaw/followees/)

+加关注

| <| 2019年4月| >  
---|---|---  
日| 一| 二| 三| 四| 五| 六  
31| 1| 2| 3| 4| 5| 6  
7| 8| 9| 10| 11| 12| 13  
14| 15| 16| 17| 18| 19| [ _20_](https://www.cnblogs.com/leolaw/archive/2019/04/20.html)  
21| 22| 23| 24| 25| 26| 27  
28| 29| 30| 1| 2| 3| 4  
5| 6| 7| 8| 9| 10| 11  
  
### 搜索

 

 

### 常用链接

  * [我的随笔](https://www.cnblogs.com/leolaw/p/ "我的博客的随笔列表")
  * [我的评论](https://www.cnblogs.com/leolaw/MyComments.html "我发表过的评论列表")
  * [我的参与](https://www.cnblogs.com/leolaw/OtherPosts.html "我评论过的随笔列表")
  * [最新评论](https://www.cnblogs.com/leolaw/RecentComments.html "我的博客的评论列表")
  * [我的标签](https://www.cnblogs.com/leolaw/tag/ "我的博客的标签列表")



### 我的标签

  * [tfs](https://www.cnblogs.com/leolaw/tag/tfs/)(3)
  * [UWA](https://www.cnblogs.com/leolaw/tag/UWA/)(1)
  * [MVVM](https://www.cnblogs.com/leolaw/tag/MVVM/)(1)
  * [net](https://www.cnblogs.com/leolaw/tag/net/)(1)
  * [netcore](https://www.cnblogs.com/leolaw/tag/netcore/)(1)



### 随笔档案

  * [2019年4月 (1)](https://www.cnblogs.com/leolaw/archive/2019/04.html)
  * [2019年3月 (3)](https://www.cnblogs.com/leolaw/archive/2019/03.html)
  * [2018年12月 (1)](https://www.cnblogs.com/leolaw/archive/2018/12.html)
  * [2018年7月 (1)](https://www.cnblogs.com/leolaw/archive/2018/07.html)
  * [2018年4月 (1)](https://www.cnblogs.com/leolaw/archive/2018/04.html)
  * [2017年12月 (1)](https://www.cnblogs.com/leolaw/archive/2017/12.html)
  * [2017年11月 (2)](https://www.cnblogs.com/leolaw/archive/2017/11.html)
  * [2016年8月 (1)](https://www.cnblogs.com/leolaw/archive/2016/08.html)



### 文章分类

  * [Web](https://www.cnblogs.com/leolaw/category/869594.html)



### 相册

  * [贴图(4)](https://www.cnblogs.com/leolaw/gallery/600755.html)



### 最新评论

  * [1\. Re:.NET Core 迁移躺坑记](https://www.cnblogs.com/leolaw/p/10740678.html#4237485)
  * @麦兜很乖嗯 这个是HttpClientFactory的套路我们正在进行中的就是这个，等周三发布上去在看效果目前我自己在测试环境下压测看起来效果良好...
  * \--LeoLaw
  * [2\. Re:.NET Core 迁移躺坑记](https://www.cnblogs.com/leolaw/p/10740678.html#4237483)
  * 你要是把core再布置到k8s就会遇到更多坑  
你要是把core再布置到谷歌和亚马逊的k8s就会遇到更多更多坑  
\----  
不说了
  * \--程小王
  * [3\. Re:.NET Core 迁移躺坑记](https://www.cnblogs.com/leolaw/p/10740678.html#4237458)
  * HttpClient的问题可以这么解决。注入 services.AddHttpClient("myhttp");调用 HttpClient client = _httpClientFactory.C.......
  * \--麦兜很乖
  * [4\. Re:.NET Core 迁移躺坑记](https://www.cnblogs.com/leolaw/p/10740678.html#4237456)
  * @麦兜很乖换类库有点儿。。工程量大先看下如果换异步方法依然有问题可能会考虑更换...
  * \--LeoLaw
  * [5\. Re:.NET Core 迁移躺坑记](https://www.cnblogs.com/leolaw/p/10740678.html#4237444)
  * Redis 超时可以用CSRedis 组件解决
  * \--麦兜很乖



### 阅读排行榜

  * [1\. .NET Core 迁移躺坑记(3395)](https://www.cnblogs.com/leolaw/p/10740678.html)
  * [2\. TFS在项目中Devops落地进程（上）(2415)](https://www.cnblogs.com/leolaw/p/7821335.html)
  * [3\. TFS在项目中DevOps落地进程（下）(1945)](https://www.cnblogs.com/leolaw/p/7847062.html)
  * [4\. Hangfire使用ApplicationInsigts监控(443)](https://www.cnblogs.com/leolaw/p/8734822.html)
  * [5\. Asp.Net 为什么需要异步(414)](https://www.cnblogs.com/leolaw/p/5785390.html)



### 评论排行榜

  * [1\. .NET Core 迁移躺坑记(39)](https://www.cnblogs.com/leolaw/p/10740678.html)
  * [2\. TFS在项目中Devops落地进程（上）(8)](https://www.cnblogs.com/leolaw/p/7821335.html)
  * [3\. Hangfire使用ApplicationInsigts监控(4)](https://www.cnblogs.com/leolaw/p/8734822.html)
  * [4\. 初探奥尔良(Orleans)(4)](https://www.cnblogs.com/leolaw/p/10546239.html)
  * [5\. TFS在项目中DevOps落地进程（下）(3)](https://www.cnblogs.com/leolaw/p/7847062.html)



### 推荐排行榜

  * [1\. .NET Core 迁移躺坑记(24)](https://www.cnblogs.com/leolaw/p/10740678.html)
  * [2\. TFS在项目中DevOps落地进程（下）(11)](https://www.cnblogs.com/leolaw/p/7847062.html)
  * [3\. TFS在项目中Devops落地进程（上）(6)](https://www.cnblogs.com/leolaw/p/7821335.html)
  * [4\. 初探奥尔良(Orleans)(3)](https://www.cnblogs.com/leolaw/p/10546239.html)
  * [5\. Hangfire使用ApplicationInsigts监控(3)](https://www.cnblogs.com/leolaw/p/8734822.html)



Copyright ©2019 LeoLaw 
